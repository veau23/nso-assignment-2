- name: Configure local HAProxy and Flask app on macOS
  hosts: localhost
  connection: local
  gather_facts: yes
  become: yes

  tasks:
    - name: Ensure Homebrew is installed
      shell: |
        which brew || /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      changed_when: false

    - name: Install HAProxy using Homebrew
      homebrew:
        name: haproxy
        state: latest

    - name: Install Nginx using Homebrew
      homebrew:
        name: nginx
        state: latest

    - name: Install Python3 and pip3
      homebrew:
        name: python
        state: latest

    - name: Install Flask via pip3
      pip:
        name: flask
        executable: pip3

    - name: Install Gunicorn
      pip:
        name: gunicorn
        executable: pip3

    - name: Copy Flask application to local path
      copy:
        src: ./application2.py
        dest: /usr/local/bin/application2.py
        mode: '0755'

    - name: Start Flask application with Gunicorn
      shell: gunicorn -w 2 -D -b 0.0.0.0:5000 application2:app
      args:
        chdir: /usr/local/bin

